options:
  machineType: N1_HIGHCPU_8
  # env:
  #   - REGION=us-west1
  #   - TAG=$BRANCH_NAME:$SHORT_SHA
  #   - SERVICE_NAME=mintaklinebot
  #   - KANIKO_CACHE_TTL=336h
logsBucket: gs://cloudbuildlog-2x
steps:
  - id: build-python
    name: gcr.io/kaniko-project/executor:latest
    args:
      - --destination=us.gcr.io/$PROJECT_ID/linebot/python:$TAG
      - --cache=true
      - --cache-ttl=336h
      - --dockerfile=deployment/dockerfile/python/Dockerfile
      - --context=.
    env:
      - "TAG=$BRANCH_NAME:$SHORT_SHA"

  - id: build-go
    name: gcr.io/kaniko-project/executor:latest
    args:
      - --destination=us.gcr.io/$PROJECT_ID/linebot/go:$BRANCH_NAME:$SHORT_SHA
      - --cache=true
      - --cache-ttl=336h
      - --dockerfile=deployment/dockerfile/go/Dockerfile
      - --context=.

  - id: Deploy To Cloud Run
    waitFor:
      - build-python
      - build-go
    name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      - run
      - deploy
      - $SERVICE_NAME
      - --image
      - us.gcr.io/$PROJECT_ID/linebot/python:$TAG
      - --region
      - $REGION
      - --platform
      - managed
    env:
      - SERVICE_NAME=mintaklinebot

images:
  - us.gcr.io/$PROJECT_ID/linebot/python
  - us.gcr.io/$PROJECT_ID/linebot/go
